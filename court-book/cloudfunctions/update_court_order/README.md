# 场地预订冲突处理机制

## 概述

本系统实现了完整的用户冲突处理机制，确保场地预订的公平性和一致性。

## 用户类型

- **管理员**: 拥有特殊权限的用户，可以预订任何场地
- **普通用户**: 一般用户，遵循标准预订规则

## 订单状态

- `free`: 空闲状态 - 可以预订
- `locked`: 锁定状态 - 用户已预订但未支付
- `booked`: 已预订状态 - 支付完成，不可更改

## 冲突处理规则

### 1. 锁定时间规则

| 用户类型 | 锁定时间 | 说明 |
|---------|---------|------|
| 管理员 | 10分钟 | 管理员预订后有10分钟支付时间 |
| 普通用户 | 5分钟 | 普通用户预订后有5分钟支付时间 |

### 2. 冲突场景处理

#### 2.1 管理员与管理员冲突
- 管理员A锁定场地后，管理员B在10分钟内无法预订
- 10分钟后，管理员B可以预订该场地
- 错误信息：`场地已被其他管理员锁定，请稍后再试`

#### 2.2 普通用户与普通用户冲突
- 用户A锁定场地后，用户B在5分钟内无法预订
- 5分钟后，用户B可以预订该场地
- 错误信息：`场地已被其他用户锁定，请稍后再试`

#### 2.3 管理员与普通用户冲突
- 管理员锁定场地后，普通用户在10分钟内无法预订
- 普通用户锁定场地后，管理员在5分钟内无法预订
- 错误信息根据锁定者类型显示

#### 2.4 已预订状态
- 任何已支付完成的订单（`booked`状态）都不允许被修改
- 错误信息：`场地已被预订，无法修改`

### 3. 特殊规则

#### 3.1 同一用户更新
- 用户可以随时更新自己的锁定订单
- 不检查锁定时间限制

#### 3.2 空闲状态
- 空闲状态的场地可以被任何用户预订
- 无冲突检查

## 技术实现

### 核心函数

```javascript
function checkCanUpdate(existingOrder, newBookedBy, managerPhones)
```

### 参数说明

- `existingOrder`: 现有订单对象
- `newBookedBy`: 新的预订者手机号
- `managerPhones`: 管理员手机号集合

### 返回值

```javascript
{
  success: boolean,    // 是否允许更新
  error?: string       // 错误信息（如果拒绝）
}
```

## 相关云函数

### update_court_order
- 处理订单创建和更新
- 实现冲突检查逻辑

### get_court_order
- 获取场地状态
- 清理过期的锁定订单

### cancel_order
- 取消订单
- 普通用户只能取消自己的订单
- 管理员可以取消任何订单

## 测试

运行测试文件验证冲突处理逻辑：

```bash
node test_conflict.js
```

## 注意事项

1. 锁定时间基于订单的 `updated_at` 字段计算
2. 系统会自动清理过期的锁定订单
3. 版本号机制确保并发安全
4. 所有操作都有相应的错误处理和用户提示 